---
title: "EPLC analysis"
date: "`r Sys.time()`"
output: word_document
---

```{r setup and import}
options(kableExtra.auto_format = FALSE) #for proper table formating in Word
knitr::opts_chunk$set(echo = TRUE,
											results = "asis")

library(tidyverse)
library(data.table)

mdata = fread("Data/final/final combined dataset.csv")




mdata$female = as.integer(mdata$female)
mdata$died_visit = as.integer(mdata$died_visit)
mdata$died_visit = case_when(
	mdata$died_visit == 0 ~ "Survived to discharge",
	mdata$died_visit == 1 ~ "Died in ED",
	mdata$died_visit == 2 ~ "Died in the hospital",
	TRUE ~ NA_character_
) %>% as.factor()


mdata$disp_ed = as.integer(mdata$disp_ed)
mdata$disp_ed = case_when(
	mdata$disp_ed == 1 ~ "Routine",
	mdata$disp_ed == 2 ~ "Transfer to short-term hospital",
	mdata$disp_ed == 5 ~ "Transfer other",
	mdata$disp_ed == 6 ~ "Home Health Care",
	mdata$disp_ed == 7 ~ "Against medical advice",
	mdata$disp_ed == 9 ~ "Admitted as inpatient",
	mdata$disp_ed == 20 ~ "Died in ED",
	mdata$disp_ed == 21 ~ "Discharged to law enforcement",
	mdata$disp_ed == 98 ~ "Not admitted to this hospital, destination unknown",
	mdata$disp_ed == 99 ~ "Not admitted to this hospital, discharged alive, destination unknown",
	TRUE ~ NA_character_
) %>% as.factor()



mdata$disp_ip = as.integer(mdata$disp_ip)
mdata$disp_ip = case_when(
	mdata$disp_ip == 1 ~ "Routine",
	mdata$disp_ip == 2 ~ "Transfer to short-term hospital",
	mdata$disp_ip == 5 ~ "Transfer other",
	mdata$disp_ip == 6 ~ "Home Health Care",
	mdata$disp_ip == 7 ~ "Against medical advice",
	mdata$disp_ip == 20 ~ "Died in hospital",
	mdata$disp_ip == 99 ~ "Discharged alive, destination unknown",
	TRUE ~ NA_character_
) %>% as.factor()




mdata$edevent = as.integer(mdata$edevent)
mdata$edevent = case_when(
	mdata$edevent == 1 ~ "Treated and released",
	mdata$edevent == 2 ~ "Admitted as inpatient",
	mdata$edevent == 3 ~ "Transferred to a short-term hospital",
	mdata$edevent == 9 ~ "Died in the ED",
	mdata$edevent == 98 ~ "Not admitted to this hospital, destination unknown",
	mdata$edevent == 99 ~ "Not admitted to this hospital, discharged alive, destination unknown",
	TRUE ~ NA_character_
) %>% as.factor()





mdata$mortality = (mdata$died_visit == "Died in ED") | (mdata$died_visit == "Died in the hospital")

mdata$mortality = as.integer(mdata$mortality)




mdata$mech1[mdata$mech1==""] = "UNSPECIFIED"





mdata$age_group = case_when(
	mdata$age %in% 50:65 ~ "50-65",
	mdata$age %in% 66:80 ~ "66-80",
	mdata$age >80 ~ "81+",
	TRUE ~ NA_integer_
)




med_iqi = function(x, w=mdata$discwt, na.rm=T){
	
	if(is.null(w)){
			sprintf("%.2f [%.2f, %.2f]",
					quantile(x=x, probs = 0.5, na.rm = na.rm), 
					quantile(x=x, probs = 0.25, na.rm = na.rm), 
					quantile(x=x, probs = 0.75, na.rm = na.rm))
	} else{
			sprintf("%.2f [%.2f, %.2f]",
					spatstat::weighted.quantile(x=x, w=w, probs = 0.5, na.rm = na.rm), 
					spatstat::weighted.quantile(x=x, w=w, probs = 0.25, na.rm = na.rm), 
					spatstat::weighted.quantile(x=x, w=w, probs = 0.75, na.rm = na.rm))
	}
	
}



my.weighted.mean = function(x, w = mdata$discwt, na.rm=T){
	
	weighted.mean(x=x, w = w, na.rm = na.rm)
	
	
}


cat_perc = function(x, w = mdata$discwt){
	
	res = data.frame(var = unique(x))
	res$n = NA_real_
	res$perc = NA_real_
	
	for(i in 1:nrow(res)){
		res$n[i] = round( sum( w[x==res$var[i] ], na.rm = T ) )
		res$perc[i] = round(my.weighted.mean(x == res$var[i])*100, 2)
	}
	
	res$var = as.character(res$var)
	res = res[!is.na(res$var), ]
	res = rbind(res, 
							c("Missing", 
								round(sum(w[ is.na(x) ])),
								round(my.weighted.mean(is.na(x))*100, 2)))
	res
	
}


```




\
\
\
\


# Overall Demographics
```{r overall demos}

mdata %>%
	summarise(n_obs = n(),
						n_weighted = sum(discwt, na.rm = T), 
						age = med_iqi(age),
						female = round(my.weighted.mean(female)*100, 2),
						mortality = round(my.weighted.mean(mortality)*100, 2),
						pDeath = med_iqi(pDeath*100)
						) %>% kableExtra::kable()


cat_perc(mdata$died_visit) %>% kableExtra::kable()

cat_perc(mdata$disp_ed) %>% kableExtra::kable()

cat_perc(mdata$edevent) %>% kableExtra::kable()

cat_perc(mdata$disp_ip) %>% kableExtra::kable()

cat_perc(mdata$mech1) %>% kableExtra::kable()




```


\
\
\
\


# Demographics by Age Group
```{r demos by age group}



mdata %>%
	group_by(age_group) %>%
	summarise(n_obs = n(),
						n_weighted = sum(discwt, na.rm = T), 
						age = med_iqi(age),
						female = round(my.weighted.mean(female)*100, 2),
						mortality = round(my.weighted.mean(mortality)*100, 2),
						pDeath = med_iqi(pDeath*100)) %>% 
	ungroup() %>%
	kableExtra::kable()



mdata %>%
	group_by(age_group) %>%
	cat_perc(died_visit) %>% 
	ungroup() %>%
	kableExtra::kable()


mdata %>%
	group_by(age_group) %>%
	cat_perc(disp_ed) %>% 
	ungroup() %>%
	kableExtra::kable()

mdata %>%
	group_by(age_group) %>%
	cat_perc(edevent) %>% 
	ungroup() %>%
	kableExtra::kable()


mdata %>%
	group_by(age_group) %>%
	cat_perc(disp_ip) %>% 
	ungroup() %>%
	kableExtra::kable()


mdata %>%
	group_by(age_group) %>%
	cat_perc(mech1)  %>% 
	ungroup() %>%
	kableExtra::kable()







```



\
\
\



# Demographics by Injury Mechanism
```{r demos by mech}



mdata %>%
	group_by(mech1) %>%
	summarise(n_obs = n(),
						n_weighted = sum(discwt, na.rm = T), 
						age = med_iqi(age),
						female = round(my.weighted.mean(female)*100, 2),
						mortality = round(my.weighted.mean(mortality)*100, 2),
						pDeath = med_iqi(pDeath*100)) %>% 
	ungroup() %>%
	kableExtra::kable()



mdata %>%
	group_by(mech1) %>%
	cat_perc(died_visit) %>% 
	ungroup() %>%
	kableExtra::kable()


mdata %>%
	group_by(mech1) %>%
	cat_perc(disp_ed) %>% 
	ungroup() %>%
	kableExtra::kable()

mdata %>%
	group_by(mech1) %>%
	cat_perc(edevent) %>% 
	ungroup() %>%
	kableExtra::kable()


mdata %>%
	group_by(mech1) %>%
	cat_perc(disp_ip) %>% 
	ungroup() %>%
	kableExtra::kable()


mdata %>%
	group_by(mech1) %>%
	cat_perc(age_group)  %>% 
	ungroup() %>%
	kableExtra::kable()







```



\
\
\



After applying the inclusion/exclusion criteria, we will first empirically estimate the median TMPM injury severity for each group of injury mechanisms as defined by the External Causes of Injury for the International Classification of Diseases Ninth and Tenth Revisions, Clinical Modifications (ICD-9-CM and ICD-10-CM, respectively). 

Then, we will rank-order the ten most severe mechanisms of injury by median injury severity value, the probability of death due exclusively to anatomic injuries, as computed using the Trauma Mortality Prediction Model (TMPM) for the ICD-9-CM and ICD-10-CM lexicons, as appropriate.  


```{r rank mechanisms of injury by median pDeath}




mdata %>%
	group_by(mech1) %>%
	summarise(n_obs = n(),
						n_weighted = sum(discwt, na.rm = T), 
						pDeath = med_iqi(pDeath)) %>%
	ungroup() %>% 
	arrange(desc(pDeath)) %>% 
	kableExtra::kable()


```







Finally, we will compare the injury profiles and case mortality rates, stratified by age group (50-65, 66-80, and >80) and  mechanism of injury group.

```{r injury profiles and mortality by age group and mechanism}



res = mdata %>%
	group_by(age_group, mech1) %>%
	summarise(n_obs = n(),
						n_weighted = sum(discwt, na.rm = T), 
						age = med_iqi(age),
						female = round(my.weighted.mean(female)*100, 2),
						mortality = round(my.weighted.mean(mortality)*100, 2),
						pDeath = med_iqi(pDeath*100)) %>% 
	ungroup() %>%
	kableExtra::kable()


```















```{r}
pander::pander(sessionInfo())
```


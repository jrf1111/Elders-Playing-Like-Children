---
title: "EPLC analysis"
date: "`r Sys.time()`"
output: word_document
---

```{r setup and import}
options(kableExtra.auto_format = FALSE) #for proper table formating in Word
knitr::opts_chunk$set(echo = TRUE,
											results = "asis")

library(tidyverse)
library(data.table)

mdata = fread("Data/final/final combined dataset.csv",
							na.strings=c(getOption("datatable.na.strings","NA"), ""),
							stringsAsFactors = TRUE
							)





med_iqi = function(x, w=mdata$discwt, na.rm=T, digits=2){
	
	digits = as.character(digits)
	
	fmt = paste0("%.", digits, "f [%.", digits, "f, %.", digits, "f]")
	
	if(is.null(w)){
			sprintf(fmt,
					quantile(x=x, probs = 0.5, na.rm = na.rm), 
					quantile(x=x, probs = 0.25, na.rm = na.rm), 
					quantile(x=x, probs = 0.75, na.rm = na.rm))
	} else{
			sprintf(fmt,
					spatstat::weighted.quantile(x=x, w=w, probs = 0.5, na.rm = na.rm), 
					spatstat::weighted.quantile(x=x, w=w, probs = 0.25, na.rm = na.rm), 
					spatstat::weighted.quantile(x=x, w=w, probs = 0.75, na.rm = na.rm))
	}
	
}



my.weighted.mean = function(x, w = mdata$discwt, na.rm=T){
	
	weighted.mean(x=x, w = w, na.rm = na.rm)
	
	
}


cat_perc = function(df, x, w = "discwt"){
	
	df = as.data.frame(df)
	x = df[, x]
	w = df[, w]
	rm(df)
	
	res = data.frame(var = unique(x))
	res$n = NA_real_
	res$perc = NA_real_
	total = sum(w, na.rm = T)
	
	for(i in 1:nrow(res)){
		res$n[i] = round( sum( w[x==res$var[i] ], na.rm = T ) )
	}
	
	res$var = as.character(res$var)
	res = res[!is.na(res$var), ]
	res = rbind(res, c("Missing", round(sum(w[ is.na(x) ])), NA))
	res$n = as.numeric(res$n)
	res$perc = round((res$n/total)*100, 2)
	
	
	res
	
}





```




\
\
\
\


# Overall Demographics
```{r overall demos}

mdata %>%
	summarise(n_obs = n(),
						n_weighted = round(sum(discwt, na.rm = T)), 
						age = med_iqi(age),
						female = round(my.weighted.mean(female)*100, 2),
						mortality = round(my.weighted.mean(mortality)*100, 2),
						pDeath = med_iqi(pDeath*100)
						) %>% kableExtra::kable()


cat_perc(mdata, "died_visit") %>% kableExtra::kable()

cat_perc(mdata, "disp_ed") %>% kableExtra::kable()

cat_perc(mdata, "edevent") %>% kableExtra::kable()

cat_perc(mdata, "disp_ip") %>% kableExtra::kable()

cat_perc(mdata, "mech1") %>% kableExtra::kable()




```


\
\
\
\


# Demographics by Age Group
```{r demos by age group}



mdata %>%
	group_by(age_group) %>%
	summarise(n_obs = n(),
						n_weighted = round(sum(discwt, na.rm = T)), 
						age = med_iqi(age, w = discwt),
						female = round(my.weighted.mean(female, w = discwt)*100, 2),
						mortality = round(my.weighted.mean(mortality, w = discwt)*100, 2),
						pDeath = med_iqi(pDeath*100, w = discwt)) %>% 
	ungroup() %>%
	kableExtra::kable()












plyr::count(mdata,  c("age_group", "died_visit"), wt_var = "discwt") %>% 
	group_by(age_group) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "age_group", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()








plyr::count(mdata,  c("age_group", "disp_ed"), wt_var = "discwt") %>% 
	group_by(age_group) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "age_group", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()



plyr::count(mdata,  c("age_group", "edevent"), wt_var = "discwt") %>% 
	group_by(age_group) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "age_group", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()



plyr::count(mdata,  c("age_group", "disp_ip"), wt_var = "discwt") %>% 
	group_by(age_group) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "age_group", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()


plyr::count(mdata,  c("age_group", "mech1"), wt_var = "discwt") %>% 
	group_by(age_group) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "age_group", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()







```



\
\
\



# Demographics by Injury Mechanism
```{r demos by mech}



mdata %>%
	group_by(mech1) %>%
	summarise(n_obs = n(),
						n_weighted = round(sum(discwt, na.rm = T)), 
						age = med_iqi(age, w=discwt),
						female = round(my.weighted.mean(female, w=discwt)*100, 2),
						mortality = round(my.weighted.mean(mortality, w=discwt)*100, 2),
						pDeath = med_iqi(pDeath*100, w=discwt)) %>% 
	ungroup() %>%
	kableExtra::kable()




plyr::count(mdata,  c("mech1", "died_visit"), wt_var = "discwt") %>% 
	group_by(mech1) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "died_visit", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()



plyr::count(mdata,  c("mech1", "disp_ed"), wt_var = "discwt") %>% 
	group_by(mech1) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "disp_ed", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()





plyr::count(mdata,  c("mech1", "edevent"), wt_var = "discwt") %>% 
	group_by(mech1) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "edevent", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()




plyr::count(mdata,  c("mech1", "disp_ip"), wt_var = "discwt") %>% 
	group_by(mech1) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "disp_ip", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()




plyr::count(mdata,  c("mech1", "age_group"), wt_var = "discwt") %>% 
	group_by(mech1) %>% 
    mutate(perc = round((freq/sum(freq))*100, 2) ) %>% 
	ungroup() %>% 
	mutate(freq = round(freq)) %>% 
    pivot_wider(names_from = "age_group", 
    						values_from = c("freq", "perc")) %>%
	kableExtra::kable()










```



\
\
\



After applying the inclusion/exclusion criteria, we will first empirically estimate the median TMPM injury severity for each group of injury mechanisms as defined by the External Causes of Injury for the International Classification of Diseases Ninth and Tenth Revisions, Clinical Modifications (ICD-9-CM and ICD-10-CM, respectively). 

Then, we will rank-order the ten most severe mechanisms of injury by median injury severity value, the probability of death due exclusively to anatomic injuries, as computed using the Trauma Mortality Prediction Model (TMPM) for the ICD-9-CM and ICD-10-CM lexicons, as appropriate.  


```{r rank mechanisms of injury by median pDeath}




res = mdata %>%
	group_by(mech1) %>%
	summarise(n_obs = n(),
						n_weighted = round(sum(discwt, na.rm = T)), 
						pDeath = med_iqi(pDeath*100, w = discwt, digits = 4)) %>%
	ungroup() %>% 
	arrange(desc(pDeath))


res$rank = 1:nrow(res)
res = res[, c("rank", "mech1", "n_obs", "n_weighted", "pDeath")]

kableExtra::kable(res)

rm(res)

```







Finally, we will compare the injury profiles and case mortality rates, stratified by age group (50-65, 66-80, and >80) and  mechanism of injury group.

```{r injury profiles and mortality by age group and mechanism}



mdata %>%
	group_by(age_group, mech1) %>%
	summarise(n_obs = n(),
						n_weighted = round(sum(discwt, na.rm = T)), 
						age = med_iqi(age, w = discwt),
						female = round(my.weighted.mean(female, w = discwt)*100, 2),
						mortality = round(my.weighted.mean(mortality, w = discwt)*100, 2),
						pDeath = med_iqi(pDeath*100, w = discwt)) %>% 
	ungroup() %>%
	kableExtra::kable()


```


\
\
\
\

https://m-clark.github.io/posts/2019-10-20-big-mixed-models/#additive-models-as-mixed-models
```{r mixed model}
library(mgcv)
library(gammit)


```













```{r}
pander::pander(sessionInfo())
```


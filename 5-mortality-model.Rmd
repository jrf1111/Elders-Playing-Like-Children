---
title: "EPLC Mortality Model"
author: "Jacob W. Roden-Foreman"
date: "`r Sys.time()`"
output:
  html_document:
    pandoc_args: "--dpi=150"
    fig_height: 3
    fig_width: 5
    code_folding: show
    df_print: kable
    toc: true
    toc_depth: 3
    toc_float: true
editor_options: 
  chunk_output_type: console
---

# Setup and import  

```{r setup and import}
knitr::opts_chunk$set(echo = TRUE,
											results = "asis")

library(tidyverse)
library(tidylog)
library(data.table)
library(fst)
library(bit64)
library(weights)
library(glmnet)
library(mgcv)
library(gammit)



mdata = read_fst("Data/final/final combined dataset with top 10.fst",
								 columns = c('hosp_ed', 'year_whole',
								 						'discwt', 
								 						'age',
								 						'age_group',
								 						'female', 'zipinc_qrtl',
								 						'pay1_recode', 
								 						'pDeath', 'elixhauser',
								 						'mortality', 
								 						'high_risk',
								 						'hosp_trauma_level',
								 						'injury_brain', 'injury_skull_fx',
								 						'injury_cspine', 'injury_rib_fx',
								 						'injury_cardio_pulm', 'injury_tspine',
								 						'injury_lspine', 'injury_solid_abd',
								 						'injury_hollow_abd', 'injury_ue_fx',
								 						'injury_pelvic_fx', 'injury_le_fx',
								 						'top_10_ecode_E8261', 'top_10_ecode_E8122', 
								 						'top_10_ecode_E8162', 'top_10_ecode_E8210', 
								 						'top_10_ecode_E8136', 'top_10_ecode_E8192',
								 						'top_10_ecode_E8182', 'top_10_ecode_E8853', 
								 						'top_10_ecode_E8152', 'top_10_ecode_E8851'
								 )
)

mdata = mdata %>% filter(high_risk == "High-risk")

mdata$hosp_ed = as.factor(mdata$hosp_ed)



```



\
\
\
\



# Preprocessing
```{r}

#select variables for consideration
mdata = mdata %>% 
	select(discwt, age, age_group, female, zipinc_qrtl, pay1_recode,
				 pDeath, elixhauser, mortality, 
				 injury_brain, injury_skull_fx, injury_cspine, injury_rib_fx,
				 injury_cardio_pulm, injury_tspine, injury_lspine, injury_solid_abd,
				 injury_hollow_abd, injury_ue_fx, injury_pelvic_fx, injury_le_fx, 
				 top_10_ecode_E8261, top_10_ecode_E8122, top_10_ecode_E8162, 
				 top_10_ecode_E8210, top_10_ecode_E8136, top_10_ecode_E8192, 
				 top_10_ecode_E8182, top_10_ecode_E8853, top_10_ecode_E8152, 
				 top_10_ecode_E8851)






#separate everything out into (sparse) matrices to reduce memory pressure
Y = mdata$mortality

W = mdata$discwt


mdata = mdata %>% mutate_at(vars(starts_with("injury_"), starts_with("top_10_ecode")),
														as.integer)


library(Matrix)

temp = poly(mdata$age, 3)
mdata$age_L = temp[, 1]
mdata$age_Q = temp[, 2]
mdata$age_C = temp[, 3]
rm(temp)

#everything except pDeath and elixhauser
X = sparse.model.matrix( ~ 
												 	#demographics
												 	age_L + age_Q + age_C + age_group + female + zipinc_qrtl + pay1_recode + 
												 	#injuries
												 	injury_brain + injury_skull_fx + injury_cspine + 
												 	injury_rib_fx + injury_cardio_pulm + injury_tspine + 
												 	injury_lspine + injury_solid_abd + injury_hollow_abd + 
												 	injury_ue_fx + injury_pelvic_fx + injury_le_fx +
												 	#ecodes
												 	top_10_ecode_E8261 + top_10_ecode_E8122 + top_10_ecode_E8162 + 
												 	top_10_ecode_E8210 + top_10_ecode_E8136 + top_10_ecode_E8192 + 
												 	top_10_ecode_E8182 + top_10_ecode_E8853 + top_10_ecode_E8152 + 
												 	top_10_ecode_E8851,
												 mdata
)
X = X[, -1] #remove the intercept










#define training and testing samples
set.seed(1111)
train = sample(c(FALSE, TRUE), size = nrow(mdata), replace = TRUE)





rm(mdata)




```




# Variable Selection  

```{r vs}

#about 9 minutes
invisible(gc())
set.seed(1111)
start = Sys.time()
start
cv_fit = cv.glmnet(y = Y[train], 
									 x = X[train, ],
									 weights = W[train],
									 nfolds = 50,
									 family = "binomial", 
									 type.measure = "mse", #use mean squared error as loss function
									 
									 #instead of default "Newton", which uses the exact hessian:
									 type.logistic = "modified.Newton", 
									 alpha = 1  #LASSO
									 #trace.it = 1 #print progress
)
stop = Sys.time()
stop - start
beepr::beep()




# lambda.min is the value of lambda that gives minimum mean cross-validated error. 
# lambda.1se is the most regularized model such that loss is within one standard error of the result from using lambda.min


plot(cv_fit)

#takes out cubic effect of zipinc_qrtl, age_group66-80,
# pay1_recode missing/unknown, pay1_recode no charge, pay1_recode other,
# pay1_recode Private insurance, injury_cspine, injury_rib_fx, 
# injury_lspine, and top_10_ecode_E8210
#still has 26 predictors... 

cv_fit$lambda.min
log(cv_fit$lambda.min)
coef(cv_fit, s = "lambda.min") %>% as.matrix()




#takes everything out
cv_fit$lambda.1se
log(cv_fit$lambda.1se)
coef(cv_fit, s = "lambda.1se") %>% as.matrix()



coef(cv_fit, s = exp(-6)) %>% as.matrix()    #p=5; linear age, injury_cardio_pulm, ecode_E8261, E8122, & E8192
coef(cv_fit, s = exp(-6.25)) %>% as.matrix() #p=9; adds cubic age, injury_skull_fx, ecode_E8136
coef(cv_fit, s = exp(-6.5)) %>% as.matrix()  #p=11; adds female, injury_solid_abd, ecode_E8152
coef(cv_fit, s = exp(-7)) %>% as.matrix()    #p=14; adds age_group81+, pay1_recodeSelf-pay, injury_pelvic_fx
coef(cv_fit, s = exp(-7.25)) %>% as.matrix() #p=17; add injury_brain, injury_hollow_abd, ecode_E8853
coef(cv_fit, s = exp(-7.5)) %>% as.matrix()  #p=19; adds linear and quad. zipinc_qrtl


#final choice:
coef(cv_fit, s = exp(-6.5)) %>% as.matrix()

coefs = coef(cv_fit, s = exp(-6.5))
coefs = data.frame( var = rownames(coefs),  b = matrix(coefs)  )
coefs = coefs[coefs$b != 0, ]
coefs

rm(cv_fit, X, Y, W, start, stop)


```


\
\



## Testing Model

https://m-clark.github.io/posts/2019-10-20-big-mixed-models/#additive-models-as-mixed-models


```{r }

mdata = read_fst("Data/final/final combined dataset with top 10.fst",
								 columns = c('hosp_ed', "neds_stratum", 
								 						'year_whole',
								 						'discwt', 
								 						'high_risk',
								 						'age', 
								 						'female', 
								 						'pDeath', 'elixhauser',
								 						'mortality', 
								 						'hosp_trauma_level',
								 						'injury_skull_fx',
								 						'injury_cardio_pulm', 
								 						'injury_solid_abd',
								 						'top_10_ecode_E8261', 'top_10_ecode_E8122',
								 						'top_10_ecode_E8136',  'top_10_ecode_E8192',
								 						'top_10_ecode_E8152'
								 )
)


mdata = mdata %>% filter(high_risk == "High-risk") %>% select(-high_risk)


test = mdata %>% filter(train != TRUE)

test$hosp_ed = as.factor(test$hosp_ed)

test$hosp_trauma_level = factor(test$hosp_trauma_level,
																ordered = FALSE)


test = test %>% mutate_if(is.logical, as.integer)

rm(mdata, train)

test$pDeath = test$pDeath*100

#~11 mins 
start = Sys.time()
start
mort_mod = bam(mortality ~ 
							 	#level 1 fixed effects:
							 	poly(age, 3, raw = T) + female + 
							 	injury_skull_fx + injury_cardio_pulm + injury_solid_abd +
							 	top_10_ecode_E8261 + top_10_ecode_E8122 + 
							 	top_10_ecode_E8136 + top_10_ecode_E8192 + 
							 	top_10_ecode_E8152 +
							 	pDeath + elixhauser +
							 	
							 	#level 2 fixed effects:
							 	hosp_trauma_level + year_whole + 
							 	
							 	#random effects via smoothers:
							 	s(hosp_ed, bs='re') + s(neds_stratum, bs="re"),
							 
							 family = binomial("logit"),
							 weights = test$discwt,
							 data = test,

							 discrete = TRUE,
							 control = list(nthreads = 3,
							 							 trace = TRUE
							 )
							 
)
end = Sys.time()
beepr::beep()

end - start

saveRDS(mort_mod, "Results/mort_mod.RDS")


mod_sum = summary(mort_mod, re.test = F)
mod_sum


fixef = extract_fixed(mort_mod, ci_level = 0.999, digits = 5)
fixef
ranef = extract_ranef(mort_mod, ci_level = 0.999, digits = 5)
ranef

```


\
\
\
\





```{r} 
pander::pander(sessionInfo())
```

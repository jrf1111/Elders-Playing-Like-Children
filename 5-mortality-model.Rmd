---
title: "EPLC Mortality Model"
author: "Jacob W. Roden-Foreman"
date: "`r Sys.time()`"
output:
  html_document:
    pandoc_args: "--dpi=150"
    fig_height: 3
    fig_width: 5
    code_folding: show
    df_print: kable
    toc: true
    toc_depth: 3
    toc_float: true
editor_options: 
  chunk_output_type: console
---

# Setup and import  

```{r setup}
knitr::opts_chunk$set(echo = TRUE,
											results = "asis")

library(tidyverse)
library(tidylog)
library(data.table)
library(fst)
suppressMessages(library(bit64))
library(weights)
library(glmnet)
library(mgcv)
library(gammit)



```



\
\
\
\



# Preprocessing
```{r preprocessing}


mdata = read_fst("Data/final/final combined dataset with top 10.fst",
								 columns = c('hosp_ed', 'year_whole',
								 						'discwt', 
								 						'age',
								 						'age_group',
								 						'female', 'zipinc_qrtl',
								 						'pay1_recode', 
								 						'pDeath', 'elixhauser',
								 						'mortality', 
								 						'high_risk',
								 						'hosp_trauma_level',
								 						'injury_brain', 'injury_skull_fx',
								 						'injury_cspine', 'injury_rib_fx',
								 						'injury_cardio_pulm', 'injury_tspine',
								 						'injury_lspine', 'injury_solid_abd',
								 						'injury_hollow_abd', 'injury_ue_fx',
								 						'injury_pelvic_fx', 'injury_le_fx'
								 )
)

mdata = mdata %>% filter(high_risk == "High-risk")

mdata$hosp_ed = as.factor(mdata$hosp_ed)



#select variables for consideration
mdata = mdata %>% 
	select(discwt, age, age_group, female, zipinc_qrtl, pay1_recode,
				 pDeath, elixhauser, mortality, 
				 injury_brain, injury_skull_fx, injury_cspine, injury_rib_fx,
				 injury_cardio_pulm, injury_tspine, injury_lspine, injury_solid_abd,
				 injury_hollow_abd, injury_ue_fx, injury_pelvic_fx, injury_le_fx)






#separate everything out into (sparse) matrices to reduce memory pressure
Y = mdata$mortality

W = mdata$discwt


mdata = mdata %>% mutate_at(vars(starts_with("injury_")), as.integer)

mdata$zipinc_qrtl = factor(mdata$zipinc_qrtl, ordered = F)

library(Matrix)

temp = poly(mdata$age, 3)
mdata$age_L = temp[, 1]
mdata$age_Q = temp[, 2]
mdata$age_C = temp[, 3]
rm(temp)

#everything except pDeath and elixhauser
X = sparse.model.matrix( ~ 
												 	#demographics
												 	age_L + age_Q + age_C + age_group + female + zipinc_qrtl + pay1_recode + 
												 	#injuries
												 	injury_brain + injury_skull_fx + injury_cspine + 
												 	injury_rib_fx + injury_cardio_pulm + injury_tspine + 
												 	injury_lspine + injury_solid_abd + injury_hollow_abd + 
												 	injury_ue_fx + injury_pelvic_fx + injury_le_fx,
												 mdata
)
X = X[, -1] #remove the intercept










#define training (80%) and testing (20%) samples
set.seed(1111)
train = rbinom(n = nrow(mdata), size = 1, prob = 0.8) %>% as.logical()



rm(mdata)




```




# Variable Selection  

```{r vs}

#about 7 minutes
invisible(gc())
start = Sys.time()
start
cv_fit = cv.glmnet(y = Y[train], 
									 x = X[train, ],
									 weights = W[train],

									 # trace.it = 1, #print progress
									 
									 nfolds = 50,
									 family = "binomial", 
									 type.measure = "deviance", #use deviance as loss function
									 
									 #instead of default "Newton", which uses the exact hessian:
									 type.logistic = "modified.Newton", 
									 alpha = 1  #LASSO
									 
)
stop = Sys.time()
stop - start
beepr::beep()


plot(cv_fit)


# lambda.min is the value of lambda that gives minimum mean cross-validated error. 
log(cv_fit$lambda.min)
coef(cv_fit, s = "lambda.min") %>% as.matrix()
# has too many predictors



# lambda.1se is the most regularized model with loss that is within one standard error of model with the least loss.
log(cv_fit$lambda.1se)
coef(cv_fit, s = "lambda.1se") %>% as.matrix()
#takes everything out except age, age^3, (age_group81+), female, 
# injury_skull_fx, and injury_cardio_pulm








#final choice:
coef(cv_fit, s = "lambda.1se") %>% as.matrix()

coefs = coef(cv_fit, s = "lambda.1se")
coefs = data.frame( var = rownames(coefs),  b = matrix(coefs)  )
coefs = coefs[coefs$b != 0, ]
coefs

rm(cv_fit, X, Y, W, start, stop)


```


\
\



# Testing Model

https://m-clark.github.io/posts/2019-10-20-big-mixed-models/#additive-models-as-mixed-models


```{r testing model}

mdata = read_fst("Data/final/final combined dataset with top 10.fst",
								 columns = c(
								 	#outcome
								 	'mortality', 
								 	
								 	#vars for case mix adjustment and clustering
								 	'hosp_ed', "neds_stratum", 
								 	'year_whole',
								 	'discwt', 
								 	'high_risk',
								 	'pDeath', 'elixhauser',
								 	'hosp_trauma_level',
								 	
								 	#exploratory vars
								 	'top_10_ecode_E8261', 'top_10_ecode_E8122', 
								 	'top_10_ecode_E8162', 'top_10_ecode_E8210', 
								 	'top_10_ecode_E8136', 'top_10_ecode_E8192',
								 	'top_10_ecode_E8182', 'top_10_ecode_E8853', 
								 	'top_10_ecode_E8152', 'top_10_ecode_E8851',
								 	
								 	#vars selected by LASSO procedure
								 	'age', 'female', 
								 	"injury_skull_fx", 
								 	"injury_cardio_pulm")
)


mdata = mdata %>% filter(high_risk == "High-risk") %>% select(-high_risk)


test = mdata %>% filter(train != TRUE)
format(nrow(test), big.mark = ",")
format(round(sum(test$discwt)), big.mark = ",")




test$hosp_ed = as.factor(test$hosp_ed)

test$hosp_trauma_level = factor(test$hosp_trauma_level,
																ordered = FALSE)


test = test %>% mutate_if(is.logical, as.integer)

rm(mdata)

test$pDeath = test$pDeath*100

test$year_whole = factor(test$year_whole)


#~11 mins 
start = Sys.time()
start
mort_mod = bam(mortality ~ 
							 	#level 1 fixed effects:
							 	poly(age, 3, raw = T) + female + 
							 	
							 	injury_skull_fx + injury_cardio_pulm + 
							 	
							 	top_10_ecode_E8261 + top_10_ecode_E8122 + top_10_ecode_E8162 + 
							 	top_10_ecode_E8210 + top_10_ecode_E8136 + top_10_ecode_E8192 + 
							 	top_10_ecode_E8182 + top_10_ecode_E8853 + top_10_ecode_E8152 + 
							 	top_10_ecode_E8851 +
							 	
							 	pDeath + elixhauser +
							 	
							 	#level 2 fixed effects:
							 	hosp_trauma_level + year_whole + 
							 	
							 	#random effects via smoothers:
							 	s(hosp_ed, bs='re') + s(neds_stratum, bs="re"),
							 
							 family = binomial("logit"),
							 weights = test$discwt,
							 data = test,
							 
							 discrete = TRUE,
							 control = list(nthreads = 3, trace = TRUE)
							 
)
end = Sys.time()
beepr::beep()

end - start

saveRDS(mort_mod, "Results/mort_mod.RDS")

options(show.signif.stars = F)

summary(mort_mod, re.test = F)


fixed = extract_fixed(mort_mod, ci_level = 0.999, digits = 5) 
fixed$OR = sprintf("%.2f", exp(fixed$value))
fixed$CI = paste0( sprintf("%.2f", exp(fixed$lower_0.05)), ", ", 
									 sprintf("%.2f", exp(fixed$upper_99.95)))
fixed$pval = if_else(fixed$p < 0.0001, "< 0.0001", sprintf("%.3f", fixed$p))
TCCD::my_print(fixed)





#another model without the super-low mortality ecodes (E818.2: Other non-collision motor vehicle traffic event injuring motorcyclist; E885.3: Fall from skis; and E885.1: Fall from roller skates)



#~11 mins 
start = Sys.time()
start
mort_mod2 = bam(mortality ~ 
									#level 1 fixed effects:
									poly(age, 3, raw = T) + female + 
									
									injury_skull_fx + injury_cardio_pulm + 
									
									top_10_ecode_E8261 + top_10_ecode_E8122 + top_10_ecode_E8162 + 
									top_10_ecode_E8210 + top_10_ecode_E8136 + top_10_ecode_E8192 + 
									#top_10_ecode_E8182 + 
									#top_10_ecode_E8853 + 
									top_10_ecode_E8152 + 
									#top_10_ecode_E8851 +
									
									pDeath + elixhauser +
									
									#level 2 fixed effects:
									hosp_trauma_level + year_whole + 
									
									#random effects via smoothers:
									s(hosp_ed, bs='re') + s(neds_stratum, bs="re"),
								
								family = binomial("logit"),
								weights = test$discwt,
								data = test,
								
								discrete = TRUE,
								control = list(nthreads = 3, trace = TRUE)
								
)
end = Sys.time()
beepr::beep()

end - start

saveRDS(mort_mod2, "Results/mort_mod2.RDS")


summary(mort_mod2, re.test = F)

fixed = extract_fixed(mort_mod2, ci_level = 0.999, digits = 5) 
fixed$OR = sprintf("%.2f", exp(fixed$value))
fixed$CI = paste0( sprintf("%.2f", exp(fixed$lower_0.05)), ", ", 
									 sprintf("%.2f", exp(fixed$upper_99.95)))
fixed$pval = if_else(fixed$p < 0.0001, "< 0.0001", sprintf("%.3f", fixed$p))
TCCD::my_print(fixed)







```


\
\
\
\





```{r} 
pander::pander(sessionInfo())
```
